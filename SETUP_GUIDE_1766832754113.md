# SIMPLE 3-STEP SETUP

## Step 1: Initialize the Bridge (in your server startup)

```typescript
// In your main server file (e.g., server/index.ts or server.ts)
import { systemAIStackBridge } from './integrations/system-ai-stack-bridge';
import { pool } from './dal/pool'; // Your database pool

// Add this after your pool is created:
systemAIStackBridge.initialize(pool);
```

## Step 2: Add Learning Calls (3 places)

### 2A. In `system-ai-handler.ts` - approveSystemAiPatch function

```typescript
// ADD THIS IMPORT at top:
import { systemAIStackBridge } from '../integrations/system-ai-stack-bridge';

// FIND the approveSystemAiPatch function and ADD this at the END (after tests run):
export async function approveSystemAiPatch(
  patch: CodePatch,
  opts?: { userId?: string | null; command?: string }
): Promise<{ ok: boolean; appliedFile: string; tests?: TestRunResult }> {
  
  // ... existing code that applies patch and runs tests ...
  
  const tests = await runProjectTests();
  systemAiState.lastTestExitCode = tests.exitCode;
  systemAiState.lastTestAt = new Date().toISOString();

  // ⭐ ADD THIS - Learn from the outcome:
  await systemAIStackBridge.learnFromProposal({
    proposalId: patch.id,
    command: opts?.command || '',
    filesAffected: [patch.filePath],
    approved: true,
    testsPassed: tests.exitCode === 0,
    testExitCode: tests.exitCode
  });

  return { ok: true, appliedFile: patch.filePath, tests };
}
```

### 2B. In `autoHealJobs.ts` - autoHealFastPath function

```typescript
// ADD THIS IMPORT at top:
import { systemAIStackBridge } from '../integrations/system-ai-stack-bridge';

// MODIFY autoHealFastPath:
export async function autoHealFastPath(pool?: Pool): Promise<void> {
  const jobId = `heal-${Date.now()}`;
  const startTime = Date.now();
  
  logger.info({ msg: 'auto_heal_fast_path_start' });
  
  try {
    const report = await runCleanSweep(pool);
    const duration = Date.now() - startTime;
    
    logger.info({ msg: 'auto_heal_fast_path_complete', report });
    
    // ⭐ ADD THIS - Learn from the heal:
    await systemAIStackBridge.learnFromAutoHeal({
      jobId,
      kind: 'clean_sweep',
      itemsProcessed: report.itemsRemoved || 0,
      duration,
      success: true
    });
    
  } catch (err: any) {
    const duration = Date.now() - startTime;
    logger.error({ msg: 'auto_heal_fast_path_error', error: err.message });
    
    // ⭐ ADD THIS - Learn from failures too:
    await systemAIStackBridge.learnFromAutoHeal({
      jobId,
      kind: 'clean_sweep',
      itemsProcessed: 0,
      duration,
      success: false
    });
    
    throw err;
  }
}
```

### 2C. In `curiosityRunner.ts` - handleSystemAiCuriosityTask function

```typescript
// ADD THIS IMPORT at top:
import { systemAIStackBridge } from '../integrations/system-ai-stack-bridge';

// MODIFY handleSystemAiCuriosityTask:
export async function handleSystemAiCuriosityTask(
  task: CuriosityTask,
  healthSnapshotId: string
): Promise<string> {
  const startTime = Date.now();
  let result: string;
  let valueScore = 0.5;
  
  try {
    switch (task.kind) {
      case 'probe':
        result = await runLatencyProbe(task.payload, healthSnapshotId);
        valueScore = 0.7;
        break;
      case 'self_test':
        result = await runSelfTestSuite(task.payload, healthSnapshotId);
        valueScore = 0.9;
        break;
      case 'data_audit':
        result = await runDataAudit(task.payload, healthSnapshotId);
        valueScore = 0.6;
        break;
      case 'refactor_suggestion':
        result = await proposeRefactor(task.payload, healthSnapshotId);
        valueScore = 0.5;
        break;
      default:
        result = 'Task type unrecognized; no-op.';
        valueScore = 0.1;
    }
    
    const duration = Date.now() - startTime;
    
    // ⭐ ADD THIS - Learn from the task:
    await systemAIStackBridge.learnFromCuriosityTask({
      taskId: task.id,
      kind: task.kind,
      result,
      duration,
      valueScore
    });
    
    return result;
  } catch (err: any) {
    // Handle error...
    throw err;
  }
}
```

## Step 3: Add the Analytics API Route

Create a new file: `server/routes/system-ai-learning-route.ts`

```typescript
import express from 'express';
import { systemAIStackBridge } from '../integrations/system-ai-stack-bridge';

const router = express.Router();

// GET /api/system-ai/learning/analytics
router.get('/learning/analytics', async (_req, res) => {
  try {
    const analytics = await systemAIStackBridge.getAllAnalytics();
    res.json({ ok: true, analytics });
  } catch (err: any) {
    res.status(500).json({ ok: false, error: err.message });
  }
});

// GET /api/system-ai/learning/file-risk/:filePath
router.get('/learning/file-risk/:filePath', async (req, res) => {
  try {
    const filePath = decodeURIComponent(req.params.filePath);
    const recommendation = await systemAIStackBridge.shouldApproveFile(filePath);
    res.json({ ok: true, recommendation });
  } catch (err: any) {
    res.status(500).json({ ok: false, error: err.message });
  }
});

export default router;
```

Then register it in your main server file:

```typescript
import systemAILearningRoutes from './routes/system-ai-learning-route';
app.use('/api/system-ai', systemAILearningRoutes);
```

## Done!

Now your System AI will automatically learn from:
- ✅ Every code proposal and its test results
- ✅ Every auto-heal run and its efficiency
- ✅ Every curiosity task and its value

And you can query the learning data at:
- `GET /api/system-ai/learning/analytics` - All learning metrics
- `GET /api/system-ai/learning/file-risk/Dashboard.tsx` - Risk for specific file

## Frontend Integration (Optional)

Add the Learning tab to your SystemsAIPanel.tsx using the code in:
`SystemsAIPanel_LEARNING_TAB.tsx`

It will display:
- System AI success rate
- Risky files
- Auto-heal efficiency
- Optimal schedule recommendations
