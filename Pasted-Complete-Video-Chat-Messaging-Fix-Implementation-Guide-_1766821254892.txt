Complete Video Chat & Messaging Fix - Implementation Guide
üéØ What This Fixes
Current Issues

‚ùå Video chat connection problems, stalls, misses
‚ùå No user camera showing
‚ùå No call notifications
‚ùå No message notifications
‚ùå No way to see who's online
‚ùå No SMS-like messaging interface

What You'll Get

‚úÖ Reliable P2P video calls with WebRTC
‚úÖ SMS-style messaging with notifications
‚úÖ Online user list with presence indicators
‚úÖ Incoming call popups with accept/reject
‚úÖ Message notification alerts
‚úÖ Click-to-call and click-to-message
‚úÖ Proper video layout (small self-view + large peer view in corner)


üì¶ Files Created For You

useP2PCall.ts - Complete WebRTC video call hook
useNotifications.ts - Real-time notification system
IncomingCallNotification.tsx - Beautiful call popup with accept/reject
ImprovedVideoCallOverlay.tsx - Proper video layout in corner
OnlineUsersList.tsx - User list with presence and actions
notification-handler.ts - Backend WebSocket handler


üöÄ Quick Start (30 minutes)
Step 1: Backend Setup (10 min)
A. Add notification handler to your main server
File: server/index.ts or server/websocket-server.ts
typescriptimport { Server as SocketIOServer } from 'socket.io';

// Copy notification-handler.ts to server/notification-handler.ts
import { setupNotificationHandler } from './notification-handler';

// Your existing Socket.IO server
const io = new SocketIOServer(server, {
  cors: {
    origin: ['http://localhost:5000', 'http://localhost:4200'],
    credentials: true,
  },
});

// ADD THIS LINE:
setupNotificationHandler(io);
B. Ensure video server is running
bash# In a separate terminal
npx tsx server/videoServer.ts
Should see: [VIDEO:4100] Dedicated video chat server running on port 4100
Step 2: Frontend Hooks (5 min)
Copy these to your project:

useP2PCall.ts ‚Üí src/hooks/useP2PCall.ts
useNotifications.ts ‚Üí src/hooks/useNotifications.ts

Step 3: Frontend Components (5 min)
Copy these to your project:

IncomingCallNotification.tsx ‚Üí src/components/IncomingCallNotification.tsx
ImprovedVideoCallOverlay.tsx ‚Üí src/components/ImprovedVideoCallOverlay.tsx
OnlineUsersList.tsx ‚Üí src/components/OnlineUsersList.tsx

Step 4: Update MessagesPage (10 min)
File: src/pages/MessagesPage.tsx
typescriptimport React, { useState } from 'react';
import { useNotifications } from '../hooks/useNotifications';
import { IncomingCallNotification } from '../components/IncomingCallNotification';
import { ImprovedVideoCallOverlay } from '../components/ImprovedVideoCallOverlay';
import { OnlineUsersList } from '../components/OnlineUsersList';

export default function MessagesPage({ userId, username }: { userId: string; username: string }) {
  const [activeCall, setActiveCall] = useState<{ conversationId: string; peerName: string } | null>(null);
  const [activeChat, setActiveChat] = useState<{ userId: string; name: string } | null>(null);

  const {
    incomingCall,
    sendCallInvitation,
    acceptCall,
    rejectCall,
  } = useNotifications({ userId });

  // Accept incoming call
  const handleAcceptCall = () => {
    const call = acceptCall();
    if (call) {
      setActiveCall({
        conversationId: call.conversationId,
        peerName: call.fromName,
      });
    }
  };

  // Initiate outgoing call
  const handleCallUser = (toUserId: string, userName: string) => {
    const conversationId = `call-${userId}-${toUserId}-${Date.now()}`;
    sendCallInvitation(toUserId, conversationId);
    setActiveCall({ conversationId, peerName: userName });
  };

  // Open chat window
  const handleMessageUser = (toUserId: string, userName: string) => {
    setActiveChat({ userId: toUserId, name: userName });
  };

  return (
    <div style={{ display: 'flex', height: '100vh' }}>
      {/* User List Sidebar */}
      <div style={{ width: 300, borderRight: '1px solid #e5e7eb' }}>
        <OnlineUsersList
          currentUserId={userId}
          onMessageClick={handleMessageUser}
          onCallClick={handleCallUser}
        />
      </div>

      {/* Chat Area */}
      <div style={{ flex: 1 }}>
        {activeChat ? (
          <div>Chat with {activeChat.name}</div>
        ) : (
          <div>Select a user to chat</div>
        )}
      </div>

      {/* Incoming Call Popup */}
      <IncomingCallNotification
        call={incomingCall}
        onAccept={handleAcceptCall}
        onReject={rejectCall}
      />

      {/* Video Call Overlay */}
      {activeCall && (
        <ImprovedVideoCallOverlay
          conversationId={activeCall.conversationId}
          peerName={activeCall.peerName}
          onClose={() => setActiveCall(null)}
        />
      )}
    </div>
  );
}

üß™ Testing Your Implementation
Test 1: Check Backend Notification Handler
bash# Start main server
npm run server

# You should see in logs:
# [NOTIFICATIONS] Client connected: <socket-id>
Test 2: Check Video Server
bash# Start video server
npx tsx server/videoServer.ts

# You should see:
# [VIDEO:4100] Dedicated video chat server running on port 4100
Test 3: Test in Browser

Open app in two different browsers (or incognito + regular)
Login as User1 in one, User2 in another
Go to Messages page in both
You should see each other in the "Online" list

Test 4: Test Messaging

In User1's browser, click the üí¨ button next to User2
Type a message and send
User2 should receive a notification

Test 5: Test Video Call

In User1's browser, click the üìπ button next to User2
User2 should see incoming call popup
Click Accept
Both users should see video windows in top-right corner


üîß Troubleshooting
Issue: "No other users found"
Cause: WebSocket not connecting
Fix:

Check backend server is running
Check browser console for connection errors
Verify port 3001 is not blocked

Issue: Video doesn't connect
Cause: WebRTC connection failed
Fix:

Check port 4100 is accessible
Check browser console for errors
Grant camera/microphone permissions
Check firewall settings

Issue: "Permission denied" for camera/microphone
Cause: Browser permissions not granted
Fix:

Click camera icon in address bar
Allow camera and microphone access
Refresh page

Issue: Can't see remote video
Cause: Peer connection not established
Fix:

Check both users clicked "Start Call"
Check network tab for WebSocket connection
Try refreshing both browsers


üìã Implementation Checklist
Backend:

 Copied notification-handler.ts to server/notification-handler.ts
 Added setupNotificationHandler(io) to main server
 Video server running on port 4100
 Main server running on port 3001

Frontend:

 Copied useP2PCall.ts to src/hooks/
 Copied useNotifications.ts to src/hooks/
 Copied all 3 components to src/components/
 Updated MessagesPage with new logic

Testing:

 Can see online users
 Can click to open chat
 Can click to start video call
 Incoming call notification appears
 Video connects successfully
 Audio works (no echo)
 Camera shows in both windows


üé® Customization Options
Change Video Window Size
In ImprovedVideoCallOverlay.tsx, adjust:
typescript// Larger windows
width: 640,  // was 480
height: 480, // was 360

// Smaller windows
width: 320,  // was 480
height: 240, // was 360
Change Video Position
typescript// Top left instead of top right
top: 16,
left: 16,  // was: right: 16

// Bottom right
bottom: 16, // was: top: 16
right: 16,
Add Message Sound
In useNotifications.ts, add:
typescriptonMessageNotification: (notification) => {
  const audio = new Audio('/sounds/message.mp3');
  audio.play();
}
Change Ringtone
In useNotifications.ts, modify playRingtone() function to use custom audio file.

üöÄ Next Steps

Add message persistence - Store messages in database
Add typing indicators - Show when peer is typing
Add read receipts - Show when messages are read
Add file sharing - Send images/files in chat
Add screen sharing - Share screen during calls
Add group calls - Support multiple participants


üí° Pro Tips

Test with different browsers - Chrome, Firefox, Safari
Test on mobile - Responsive layout works on phones
Use HTTPS in production - Required for camera/mic access
Add TURN server - For users behind strict firewalls
Monitor connection quality - Track packet loss, latency