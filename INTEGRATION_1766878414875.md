# NeuroCore V2: Triple AI Architecture

## Architecture Overview

```
BRAIN AI (Iracore) - STANDALONE
├── MODEL 1: DeepSeek V3 (6 Nodes - Technical/Reasoning)
│   ├── CALCULATIONS → ALGEBRA, CALCULUS, NUMERICAL → 9 domains
│   ├── CHEMISTRY → POLYMERS, FORMULATIONS, REACTIONS → 9 domains
│   ├── PHYSICS → THERMO, MECHANICS, FLUIDS → 9 domains
│   ├── FORMULAS → ENGINEERING, CONVERSIONS, CONSTANTS → 9 domains
│   ├── WEAR → ABRASION, CORROSION, EROSION → 9 domains
│   └── HYDRAULICS → SLURRY, PUMPS, PIPING → 9 domains
│
├── MODEL 2: GPT-4o Mini (6 Nodes - Creative/Visual)
│   ├── BLUEPRINTS → DRAWINGS, SCHEMATICS, LAYOUTS → 9 domains
│   ├── CAD → 3D-MODEL, CAD-SW, GEOMETRY → 9 domains
│   ├── 3D-PRINTING → PROCESSES, MATERIALS, PROTOTYPING → 9 domains
│   ├── IMAGES → ANALYSIS, RENDERING, VIS-DOCS → 9 domains
│   ├── DOCUMENTATION → WRITING, SPECS, DATASHEETS → 9 domains
│   └── GENERAL → QA, EXPLAIN, HELP → 9 domains
│
└── MODEL 3: Claude 3 Haiku (6 Nodes - Analysis/Precision)
    ├── MATERIALS → ELASTOMERS, PROPERTIES, SELECTION → 9 domains
    ├── MINING → OPERATIONS, OIL-SANDS, PROCESSING → 9 domains
    ├── MANUFACTURING → CASTING, VULC, PRODUCTION → 9 domains
    ├── QUALITY → TESTING, INSPECTION, STANDARDS → 9 domains
    ├── BONDING → ADHESIVES, SURF-PREP, CURE-SYS → 9 domains
    └── PRODUCTS → SELECTION, APPLICATIONS, SOLUTIONS → 9 domains

Total: 18 Nodes × 3 Stacks × 3 Domains = 162 Domains
```

## Device Modes

| Mode | Limits | Domains/Model | Default For |
|------|--------|---------------|-------------|
| Standard | 2-1-1 | 2 | Mobile, Tablet |
| Professional | 2-2-2 | 4 | Laptop |
| Advanced | 3-3-3 | 9 | Desktop, Server |

## Fast Label-Based Routing

```
User Prompt: "Calculate the stress on this pipe"
    │
    ▼
┌─────────────────────────────────────────┐
│ LABEL MATCHING (O(1) lookup)            │
├─────────────────────────────────────────┤
│ "calculate" → CALCULATIONS node         │
│ "stress" → MECHANICS stack              │
│ "pipe" → PIPE FLOW domain               │
└─────────────────────────────────────────┘
    │
    ▼
Model 1 routes to: CALCULATIONS → MECHANICS → STRESS
Model 2 routes to: BLUEPRINTS → DRAWINGS → MECHANICAL
Model 3 routes to: MATERIALS → PROPERTIES → MECHANICAL
    │
    ▼
3 Parallel Responses → Knowledge Algorithm → Final Answer
```

## Installation

### 1. Run Database Migration

```bash
psql $DATABASE_URL -f migrations/006_triple_ai_architecture.sql
```

### 2. Copy Files to Your Project

```
server/ai/
├── index.ts
├── core/
│   ├── types.ts
│   ├── auto-router.ts
│   └── ai-system-handler.ts
├── knowledge/
│   └── algorithms.ts
├── brain/
│   └── brain-ai.ts
├── heart/
│   └── heart-ai.ts
└── system/
    └── system-ai.ts

server/routes/
└── triple-ai-v2.ts
```

### 3. Add Routes to Server

```typescript
// server/index.ts
import tripleAiV2Routes from './routes/triple-ai-v2';
app.use('/api/v2', tripleAiV2Routes);
```

### 4. Connect to Your AI Client

In `server/ai/core/ai-system-handler.ts`, update `callAIModel()` to use your existing unified-ai-client:

```typescript
async function callAIModel(config: AIModelConfig, prompt: string) {
  const { unifiedAiClient } = await import('../unified-ai-client');
  const response = await unifiedAiClient.generate({
    provider: config.provider,
    model: config.modelName,
    prompt,
    maxTokens: config.maxTokens,
    temperature: config.temperature,
  });
  return { text: response.text, success: response.status === 'success' };
}
```

## API Endpoints

### Brain AI
```
POST /api/v2/brain/chat         { prompt, mode?, deviceClass? }
POST /api/v2/brain/standard     { prompt }  → 2-1-1
POST /api/v2/brain/professional { prompt }  → 2-2-2
POST /api/v2/brain/advanced     { prompt }  → 3-3-3
```

### Heart AI
```
POST /api/v2/heart/analyze  { prompt, mode?, context? }
POST /api/v2/heart/repair   { errorMessage, codeFile, codeContent }
POST /api/v2/heart/optimize { codeFile, codeContent, goal }
```

### System AI
```
POST /api/v2/system/analyze     { prompt, mode?, context? }
POST /api/v2/system/health-check { metrics }
POST /api/v2/system/auto-heal   { issue, diagnosticData }
```

### Admin
```
POST /api/v2/admin/refresh-cache
GET  /api/v2/admin/nodes/:aiType
GET  /api/v2/admin/stacks/:nodeId
GET  /api/v2/admin/domains/:stackId
GET  /api/v2/admin/mode-limits
GET  /api/v2/health
```

## Usage Examples

### Standard Mode (Mobile)
```typescript
const response = await fetch('/api/v2/brain/chat', {
  method: 'POST',
  body: JSON.stringify({
    prompt: 'Calculate pipe stress',
    deviceClass: 'mobile'  // Auto-selects standard mode
  })
});
// Routes: 2 nodes → 1 stack each → 1 domain each = 2 domains
```

### Advanced Mode (Desktop)
```typescript
const response = await fetch('/api/v2/brain/advanced', {
  method: 'POST',
  body: JSON.stringify({ prompt: 'Full wear analysis for hydrotransport pipeline' })
});
// Routes: 3 nodes → 3 stacks each → 3 domains each = 9 domains per model
```

## Database Tables

- `ai_nodes` - 18 Brain nodes (6 per model) + Heart/System nodes
- `ai_stacks` - 54 Brain stacks (3 per node)
- `ai_domains` - 162 Brain domains (3 per stack)
- `ai_memories` - Memories (Brain = isolated, Heart+System = shared)
- `knowledge_tree` - Knowledge tree (Brain = isolated, Heart+System = shared)
- `ai_model_config` - Model configuration per AI type
- `device_profiles` - Device class → default mode mapping
- `ai_routing_log` - Routing decisions for learning
- `ai_response_log` - Full response logs

## Adding New Nodes/Stacks/Domains

```sql
-- Add new node to Model 1
INSERT INTO ai_nodes (id, ai_type, model_slot, name, label, keywords, priority)
VALUES ('brain-m1-custom', 'brain', 1, 'Custom Node', 'CUSTOM', 
        ARRAY['keyword1', 'keyword2'], 80);

-- Add stack to node
INSERT INTO ai_stacks (id, node_id, ai_type, name, label, keywords, priority)
VALUES ('brain-m1-custom-stack', 'brain-m1-custom', 'brain', 'Custom Stack', 
        'CUSTOM-STACK', ARRAY['stack-kw'], 100);

-- Add domain to stack
INSERT INTO ai_domains (id, stack_id, node_id, ai_type, name, keywords, priority)
VALUES ('d-custom', 'brain-m1-custom-stack', 'brain-m1-custom', 'brain',
        'Custom Domain', ARRAY['domain-kw'], 100);
```

## Response Format

```json
{
  "success": true,
  "answer": "Final answer from knowledge algorithm",
  "mode": "professional",
  "metrics": {
    "totalTimeMs": 2500,
    "qualityScore": 0.85,
    "totalDomains": 12,
    "model1": {
      "provider": "openrouter",
      "model": "deepseek/deepseek-chat",
      "timeMs": 800,
      "success": true,
      "nodes": ["CALCULATIONS", "PHYSICS"],
      "stacks": ["ALGEBRA", "MECHANICS"],
      "domains": ["Linear Equations", "Stress"]
    },
    "model2": { ... },
    "model3": { ... }
  },
  "knowledgeAlgorithmLog": "Coherence: 78%\nPrimary: Model 1 (85%)"
}
```
